<?xml version="1.0" encoding="utf-8"?>
<AccessKeySecret>
  <class name="AccessKeySecret">
    <main>
      <summary>
        Encrypts and verifies access key tokens with a dynamic permission bitmap protected by RSA + AES-GCM.
      </summary>
      <remarks>
        <para>Plaintext Layout:</para>
        <list type="bullet">
          <item><description>[0]                          : Version (1 byte)</description></item>
          <item><description>[1..32]                      : Nonce (32 bytes random entropy)</description></item>
          <item><description>[33..48]                     : IssuerToolId (16 raw Guid bytes)</description></item>
          <item><description>[49..64]                     : AccessManagerId (16 raw Guid bytes)</description></item>
          <item><description>[65..72]                     : IssuedAtUnix (Int64, big-endian, seconds since Unix epoch)</description></item>
          <item><description>[73..80]                     : NotAfterUnix (Int64, big-endian, 0 = no expiry)</description></item>
          <item><description>[81..82]                     : SubjectLengthSize (UInt16, big-endian) = S</description></item>
          <item><description>[83..(83+S-1)]               : SubjectBytes (UTF-16LE serialized subject string)</description></item>
          <item><description>[83+S..83+S+1]               : PermissionBlockCount (UInt16, big-endian) = B</description></item>
          <item><description>[83+S+2..(83+S+2+(B*16)-1)]  : PermissionBitmap (B * 16 bytes, variable size)</description></item>
          <item><description>[83+S+2+(B*16)..(..+15)]     : Salt (16 bytes random)</description></item>
          <item><description>[83+S+2+(B*16)+16..end]      : AccessKeyToken (64 bytes SHA-512 hash over Version..Salt)</description></item>
        </list>
        <para>Derived Size Formulas:</para>
        <list type="bullet">
          <item><description>FixedPrefix = VersionSize + NonceSize + GuidSize + GuidSize + TimeStampSize + TimeStampSize + SubjectLengthSize = 83 bytes</description></item>
          <item><description>PlaintextLength = FixedPrefix + S + PermissionBlockCountSize + (B * BytesPerBlock) + SaltSize + TokenHashSize</description></item>
        </list>
        <para>Associated Authenticated Data (AAD):</para>
        <list type="bullet">
          <item><description>AAD = Version (1 byte) | IssuerToolId (16 bytes) | AccessManagerId (16 bytes)</description></item>
        </list>
        <para>Permission Bitmap Semantics:</para>
        <list type="bullet">
          <item><description>Up to 128 blocks * 128 bits = 16384 operation indices (0..16383).</description></item>
          <item><description>Block = index / 128, Bit = index % 128.</description></item>
          <item><description>Each block serialized big-endian; internal bit numbering uses LSB = bit 0 for shift operations.</description></item>
        </list>
        <para>AccessKeyToken (Integrity Hash):</para>
        <list type="bullet">
          <item><description>AccessKeyToken = SHA-512(plaintext[0..SaltEnd]).</description></item>
        </list>
        <para>Security Properties:</para>
        <list type="bullet">
          <item><description>Confidentiality: AES-256-GCM.</description></item>
          <item><description>Integrity and Authenticity: GCM tag over ciphertext + AAD plus internal SHA-512 hash.</description></item>
          <item><description>Token Identity / Revocation Handle: 64-byte AccessKeyToken.</description></item>
        </list>
        <para>Failure Modes:</para>
        <list type="bullet">
          <item><description>Certificate null or issuer Guid empty.</description></item>
          <item><description>Subject length exceeds UInt16 maximum.</description></item>
          <item><description>Operation index out of range (&lt;0 or ≥16384) during creation.</description></item>
          <item><description>Decryption failure (tag mismatch, RSA unwrap failure, structural corruption).</description></item>
          <item><description>Version mismatch (plaintext[0] != supported version).</description></item>
          <item><description>Length / bounds inconsistency (computed lengths exceed buffer).</description></item>
          <item><description>Issuer mismatch (decrypted IssuerToolId != expected).</description></item>
          <item><description>Hash mismatch (recomputed SHA-512 != stored AccessKeyToken).</description></item>
          <item><description>Expired (current time &gt; NotAfterUnix when NotAfterUnix != 0).</description></item>
        </list>
      </remarks>
    </main>

    <method name="TryCreate">
      <summary>Create an encrypted access token.</summary>
      <param name="certificate" Cref="X509Certificate2">X509 certificate containing public/private key pair.</param>
      <param name="toolid" Cref="Guid">Guid identifying the issuing tool instance.</param>
      <param name="accessmanagerid" Cref="Guid">Guid identifying the AccessManager instance.</param>
      <param name="subject" Cref="String">Subject string (identity namespace) serialized as UTF-16LE.</param>
      <param name="operations" Cref="IEnumerable{Int32}">Sequence of operation indices to authorize (0..16383).</param>
      <param name="lifetime" Cref="TimeSpan?">Optional lifetime for expiry; if null or &lt;= 0 then token does not expire (NotAfterUnix = 0).</param>
      <param name="secret" Cref="Byte[]">Output: encrypted token bytes on success.</param>
      <param name="token" Cref="token">Output: 64-byte token identity.</param>
      <returns Cref="Boolean">True on success; false otherwise.</returns>
      <remarks>
        <list type="number">
          <item><description>Validate inputs: certificate non-null, toolid not empty, subject length ≤ UInt16.MaxValue.</description></item>
          <item><description>Calculate the minimum number of permission blocks required and set bits for each operation index; reject any out-of-range index.</description></item>
          <item><description>Generate Nonce and Salt via a CSPRNG.</description></item>
          <item><description>Serialize fields in order, using big-endian for multi-byte integers.</description></item>
          <item><description>Compute SHA-512 hash over Version..Salt and append as token.</description></item>
          <item><description>Encrypt whole plaintext with (AES-GCM + RSA key wrap) using AAD = Version|toolid|accessmanagerid.</description></item>
        </list>
      </remarks>
    </method>

    <method name="TryParse">
      <summary>Decrypts, validates, and extracts token metadata.</summary>
      <param name="secret" Cref="ReadOnlySpan{Byte}">Serialized encrypted token bytes.</param>
      <param name="certificate" Cref="X509Certificate2">Certificate containing RSA private key for decryption.</param>
      <param name="toolid" Cref="Guid">Tool Issuer ID expected for this token.</param>
      <param name="accessmanagerid" Cref="Guid">AccessManager ID expected for this token.</param>
      <param name="subject" Cref="String">Output: recovered subject string.</param>
      <param name="permissions" Cref="ReadOnlyMemory{Byte}">Output: copy of the variable-length permission bitmap.</param>
      <param name="issuedat" Cref="DateTimeOffset">Output: Issued time.</param>
      <param name="notafter" Cref="DateTimeOffset?">Output: Expiration time if present; null if not set.</param>
      <param name="token" Cref="AccessKeyToken">Output: AccessKeyToken.</param>
      <param name="expired" Cref="Boolean">True if token has expired.</param>
      <returns Cref="Boolean">True if decrypted and validated successfully; false otherwise.</returns>
      <remarks>
        <list type="number">
          <item><description>Attempt decryption with AAD = Version|toolid|accessmanagerid.</description></item>
          <item><description>Validate structure (minimum lengths, subject and permission bounds).</description></item>
          <item><description>Confirm Version and toolid.</description></item>
          <item><description>Recompute SHA-512 and constant-time compare with stored AccessKeyToken.</description></item>
          <item><description>Expose permission bitmap and expiration; flag expiration status.</description></item>
        </list>
      </remarks>
    </method>

    <method name="GetEncryptionOverhead">
      <summary>Calculates the required encryption overhead.</summary>
      <param name="certificate" Cref="X509Certificate2">The certificate used for encryption.</param>
      <returns Cref="Int32">The approximate required overhead in bytes.</returns>
    </method>

    <field name="BitsPerBlock">
      <summary>Number of bits per permission block (128).</summary>
    </field>
    <field name="BytesPerBlock">
      <summary>Number of bytes per permission block (16).</summary>
    </field>
    <field name="FixedPrefixBeforeSubject">
      <summary>Number of bytes from start of plaintext up to (but not including) SubjectBytes (VersionSize + NonceSize + GuidSize + GuidSize + TimeStampSize + TimeStampSize + SubjectLengthSize = 83).</summary>
    </field>
    <field name="FixedTailSize">
      <summary>Size in bytes of the fields that follow the variable-length permission bitmap (SaltSize + TokenHashSize = 80).</summary>
    </field>
    <field name="GuidSize">
      <summary>Size in bytes of a Guid (16).</summary>
    </field>
    <field name="MaxOperations">
      <summary>Maximum supported operation index count (MaxPermissionBlocks * BitsPerBlock = 16384).</summary>
    </field>
    <field name="MaxPermissionBlocks">
      <summary>Maximum number of UInt128 blocks (128) allowed in the permission bitmap.</summary>
    </field>
    <field name="MinPlaintextLength">
      <summary>Minimum possible plaintext length, where subject length and permission block count are zero.</summary>
    </field>
    <field name="NonceSize">
      <summary>Nonce size (32 bytes).</summary>
    </field>
    <field name="PermissionBlockCountSize">
      <summary>Size in bytes of the permission block count field (2).</summary>
    </field>
    <field name="SaltSize">
      <summary>Salt size (16 bytes) for hash diversification.</summary>
    </field>
    <field name="SubjectLengthSize">
      <summary>Size in bytes of the subject length field (2).</summary>
    </field>
    <field name="TimeStampSize">
      <summary>Size in bytes of a timestamp (8).</summary>
    </field>
    <field name="TokenHashSize">
      <summary>AccessKeyToken hash size (64 bytes).</summary>
    </field>
    <field name="Version">
      <summary>Version identifier (0x01).</summary>
    </field>
    <field name="VersionSize">
      <summary>Size in bytes of the version field (1).</summary>
    </field>

  </class>
</AccessKeySecret>
<?xml version = "1.0" encoding = "utf-8" ?>

<CommonSecret>    
    <class name = "CommonSecret">
        <main>
            <summary>A Secret for Common object security.</summary>
            <remarks>
                <para>Plaintext layout:</para>
                <list type="bullet">
                    <item>[0] Version = 0x01</item>
                    <item>[1] SerialLength = S (1..MaxSerialNumberLength)</item>
                    <item>[2..1+S] Serial bytes (certificate.SerialNumberBytes)</item>
                    <item>[Next SaltSize] Salt (cryptographically random)</item>
                    <item>[Next HashSize] Hash = SHA512( Serial || Salt )</item>
                </list>
                <para>Total length = PlaintextPrefixSize + S + SaltSize + HashSize</para>
            </remarks>
        </main>
        <property name = "Version">
            <summary>Secret version identifier.</summary>
            <returns Cref = "Byte">The version of the secret format.</returns>
        </property>
        <constructor name = "Constructor">
            <summary>Initializes a new instance of CommonSecret with the specified ciphertext envelope and version.</summary>
            <param name = "secret" Cref = "Byte[]">Ciphertext envelope bytes.</param>
            <param name = "version" Cref = "Byte">Version identifier.</param>
        </constructor>
        <method name = "CreateV1">
            <summary>Creates a new secret for the specified certificate and object ID.</summary>
            <param name = "certificate" Cref = "X509Certificate2?">Certificate used for secret creation.</param>
            <param name = "objectid" Cref = "Guid?">Object ID to bind the secret.</param>
            <returns Cref = "CommonSecret?">A new secret instance, or null if creation fails.</returns>
            <remarks>
                <para>Creates a new secret:</para>
                <list type="number">
                    <item><description>Validates the certificate and object ID.</description></item>
                    <item><description>Constructs the plaintext as: [Version][SerialLength][Serial][Salt][Hash], where Hash = SHA512(Serial || Salt).</description></item>
                    <item><description>Constructs AAD as the concatenation of the certificate serial and object ID bytes.</description></item>
                    <item><description>Encrypts the plaintext into a secure envelope, binding the AAD.</description></item>
                    <item><description>Returns a new CommonSecret instance containing the ciphertext envelope bytes and version.</description></item>
                </list>
            </remarks>
        </method>
        <method name = "GetBytes">
            <summary>Returns the encrypted envelope bytes.</summary>
            <returns Cref = "Byte[]">The ciphertext envelope.</returns>
        </method>
        <method name = "TryValidate">
            <summary>Validates a secret against the specified certificate and object ID.</summary>
            <param name = "secret" Cref = "ReadOnlySpan{Byte}">Ciphertext envelope bytes to validate.</param>
            <param name = "certificate" Cref = "X509Certificate2?">Certificate used for validation.</param>
            <param name = "objectid" Cref = "Guid?">Object ID to bind the secret.</param>
            <returns Cref = "Boolean">True if the secret is valid; otherwise, false.</returns>
        </method>
        <method name = "TryValidateV1">
            <summary>Validates a version 1 secret against the specified certificate and object ID.</summary>
            <param name = "secret" Cref = "ReadOnlySpan{Byte}">Ciphertext envelope bytes to validate.</param>
            <param name = "certificate" Cref = "X509Certificate2?">Certificate used for validation.</param>
            <param name = "objectid" Cref = "Guid?">Object ID to bind the secret.</param>
            <returns Cref = "Boolean">True if the secret is valid; otherwise, false.</returns>
            <remarks>
                <list type="number">
                    <item><description>Validates the certificate and object ID.</description></item>
                    <item><description>Decrypts the secret using the AAD (certificate serial + object ID bytes).</description></item>
                    <item><description>Checks the secret format, version, and verifies the hash (SHA512(Serial || Salt)).</description></item>
                </list>
                <para>Returns false if any validation or cryptographic operation fails.</para>
            </remarks>
        </method>
        <field name="AesKeySize">
            <summary>Size of the AES key in bytes (AES-256).</summary>
        </field>
        <field name="GuidSize">
            <summary>Size in bytes of a Guid (16).</summary>
        </field>
        <field name="HashSize">
            <summary>Size in bytes of the SHA512 hash (64).</summary>
        </field>
        <field name="HeaderPrefixSize">
            <summary>Size of the fixed-length portion of the header (Version + RsaLength).</summary>
        </field>
        <field name="MaxPlaintext">
            <summary>Maximum allowed plaintext size in bytes.</summary>
        </field>
        <field name="MaxSerialNumberLength">
            <summary>Maximum allowed length for a certificate serial number (255).</summary>
        </field>
        <field name="NonceSize">
            <summary>Size of the AES-GCM nonce in bytes (12).</summary>
        </field>
        <field name="PlaintextPrefixSize">
            <summary>Size in bytes of the plaintext prefix (Version + SerialNumberLength = 2).</summary>
        </field>
        <field name="RsaKeyLimit">
            <summary>Maximum expected size of the RSA-wrapped key material.</summary>
        </field>
        <field name="RsaLengthSize">
            <summary>Size of the field that stores the length of the RSA-wrapped key material.</summary>
        </field>
        <field name="SaltSize">
            <summary>Size in bytes of the random salt (16).</summary>
        </field>
        <field name="TagSize">
            <summary>Size of the AES-GCM authentication tag in bytes.</summary>
        </field>
        <field name="V1">
            <summary>The version 1 identifier byte (0x01).</summary>
        </field>
        <field name="VersionSize">
            <summary>Size of the envelope version field in bytes.</summary>
        </field>
    </class>
</CommonSecret>